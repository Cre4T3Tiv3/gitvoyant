name: ğŸ”® GitVoyant CI/CD
on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  lint-and-format:
    name: ğŸ” Lint & Format Check
    runs-on: ubuntu-latest
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
    - name: ğŸ Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    - name: âš¡ Install UV
      run: |
        curl -LsSf https://astral.sh/uv/install.sh | sh
        echo "$HOME/.cargo/bin" >> $GITHUB_PATH
    - name: ğŸ”§ Bootstrap Environment
      run: make bootstrap
    - name: ğŸ§ª Install Dev Dependencies
      run: make dev
    - name: ğŸ” Run Linting
      run: make lint
    - name: âœ¨ Check Formatting
      run: |
        make format
        # Check if formatting changed anything
        git diff --exit-code || (echo "âŒ Code is not properly formatted. Run 'make format' locally." && exit 1)

  test:
    name: ğŸ§ª Test Suite
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.11', '3.12']
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    - name: ğŸ Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
    - name: âš¡ Install UV
      run: |
        curl -LsSf https://astral.sh/uv/install.sh | sh
        echo "$HOME/.cargo/bin" >> $GITHUB_PATH
    - name: ğŸ”§ Bootstrap Environment
      run: make bootstrap
    - name: ğŸ§ª Install Dev Dependencies
      run: make dev
    - name: ğŸ”¬ Run Unit Tests
      run: make test-unit
    - name: ğŸ”— Run Integration Tests
      env:
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      run: make test-integration
    # TODO: Fix CLI tests in future release
    # - name: ğŸ’» Run CLI Tests
    #   run: make test-cli
    - name: ğŸ“Š Generate Coverage Report (excluding CLI tests)
      env:
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      run: |
        # Run coverage excluding CLI tests
        PYTHONPATH=src .venv/bin/pytest --cov=gitvoyant --cov-report=term-missing --cov-fail-under=65 tests/unit tests/integration

  # TODO: Re-enable CLI integration tests in future release
  # cli-integration:
  #   name: ğŸ–¥ï¸ CLI Integration Test
  #   runs-on: ubuntu-latest
  #   steps:
  #   - name: ğŸ“¥ Checkout Code
  #     uses: actions/checkout@v4
  #     with:
  #       fetch-depth: 0
  #   - name: ğŸ Set up Python 3.11
  #     uses: actions/setup-python@v4
  #     with:
  #       python-version: '3.11'
  #   - name: âš¡ Install UV
  #     run: |
  #       curl -LsSf https://astral.sh/uv/install.sh | sh
  #       echo "$HOME/.cargo/bin" >> $GITHUB_PATH
  #   - name: ğŸ”§ Bootstrap Environment
  #     run: make bootstrap
  #   - name: ğŸ§ª Test CLI Installation
  #     run: |
  #       source .venv/bin/activate
  #       gitvoyant --help
  #       gitvoyant version
  #   - name: ğŸ”® Test Temporal Analysis
  #     run: |
  #       source .venv/bin/activate
  #       # Test temporal analysis on this repo
  #       gitvoyant analyze temporal . --window-days 30
  #   - name: ğŸ¤– Test Agent Mode
  #     env:
  #       ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
  #     run: |
  #       source .venv/bin/activate
  #       # Test that agent can start (but don't run interactive session)
  #       if [ -n "$ANTHROPIC_API_KEY" ]; then
  #         echo "ğŸ¤– Testing agent mode with API key..."
  #         timeout 10s gitvoyant analyze agent || true
  #       else
  #         echo "âš ï¸ Skipping agent tests - no API key available"
  #       fi

  security:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
    - name: ğŸ Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    - name: ğŸ”’ Run Bandit Security Scan
      run: |
        pip install bandit[toml]
        bandit -r src/ -f json -o bandit-report.json || true
    - name: ğŸ“‹ Upload Security Report
      uses: actions/upload-artifact@v4
      with:
        name: security-report
        path: bandit-report.json